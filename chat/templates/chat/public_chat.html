<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stranger Chat</title>
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --muted: #94a3b8;
      --primary: #6366f1;
      --primary-strong: #4f46e5;
      --bubble-me: #3730a3;
      --bubble-other: #1f2937;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1020 0%, #0f172a 100%);
      color: #e5e7eb;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .container {
      width: 100%;
      max-width: 900px;
      background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, rgba(255,255,255,0.02) 100%);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 90vh;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      background: rgba(17,24,39,0.6);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      backdrop-filter: blur(8px);
    }
    header .title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 14px;
    }
    .status .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.15);
    }
    .actions button {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.12);
      color: #e5e7eb;
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .actions button:hover { border-color: rgba(255,255,255,0.22); }

    .messages {
      flex: 1;
      padding: 16px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: radial-gradient(1200px 600px at 100% -10%, rgba(79,70,229,0.12), transparent),
                  radial-gradient(1000px 500px at 0% 110%, rgba(236,72,153,0.08), transparent);
    }
    .bubble {
      max-width: min(75%, 680px);
      padding: 10px 12px;
      border-radius: 16px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-wrap: break-word;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04), 0 1px 1px rgba(0,0,0,0.25);
    }
    .me { align-self: flex-end; background: linear-gradient(180deg, rgba(99,102,241,0.3), rgba(99,102,241,0.12)); border: 1px solid rgba(99,102,241,0.35); }
    .other { align-self: flex-start; background: rgba(31,41,55,0.6); border: 1px solid rgba(255,255,255,0.06); }
    .meta { font-size: 12px; color: var(--muted); margin-bottom: 4px; }

    .input {
      display: flex;
      gap: 10px;
      padding: 12px;
      border-top: 1px solid rgba(255,255,255,0.06);
      background: rgba(17,24,39,0.6);
      backdrop-filter: blur(8px);
    }
    .input input {
      flex: 1;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(2,6,23,0.45);
      color: #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      outline: none;
    }
    .input input:focus { border-color: rgba(99,102,241,0.65); box-shadow: 0 0 0 3px rgba(99,102,241,0.18); }
    .send {
      background: linear-gradient(180deg, var(--primary), var(--primary-strong));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(99,102,241,0.25);
    }
    .send:active { transform: translateY(1px); }

    .auth-section {
      background: rgba(17,24,39,0.8);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 16px;
      text-align: center;
    }
    .auth-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 12px;
    }
    .auth-btn {
      background: linear-gradient(180deg, var(--primary), var(--primary-strong));
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
    }
    .auth-btn.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.2);
      color: #e5e7eb;
    }
    .user-info {
      color: #10b981;
      font-size: 14px;
      margin-bottom: 8px;
    }

    @media (max-width: 640px) {
      .container { height: 92vh; }
      .bubble { max-width: 85%; }
      header { padding: 12px; }
      .input { padding: 10px; }
      .auth-buttons { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21 15a4 4 0 01-4 4H8l-5 3V7a4 4 0 014-4h10a4 4 0 014 4v8z" stroke="#a5b4fc" stroke-width="1.5"/>
        </svg>
        <span>Stranger Chat</span>
      </div>
      <div class="status">
        <span class="dot" id="dot"></span>
        <span id="status">Connecting…</span>
      </div>
      <div class="actions">
        <button id="next">Next</button>
        <button id="leave">Leave</button>
      </div>
    </header>

    <!-- <div class="auth-section" id="authSection">
      <div class="user-info" id="userInfo" style="display: none;">
        Welcome, <span id="username"></span>! <a href="{% url 'accounts:logout' %}" style="color: #ef4444; text-decoration: none;">Logout</a>
      </div>
      <div id="authPrompt">
        <p>Choose how you want to chat:</p>
        <div class="auth-buttons">
          <a href="{% url 'public_chat' %}" class="auth-btn">Start Chatting Anonymously</a>
          <a href="{% url 'accounts:login' %}" class="auth-btn secondary">Login</a>
          <a href="{% url 'accounts:register' %}" class="auth-btn secondary">Create Account</a>
        </div>
      </div>
    </div> -->

    <main id="messages" class="messages"></main>

    <div class="input">
      <input id="text" type="text" placeholder="Type your message…" autocomplete="off" />
      <button id="send" class="send">Send</button>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const dotEl = document.getElementById('dot');
    const listEl = document.getElementById('messages');
    const inputEl = document.getElementById('text');
    const sendBtn = document.getElementById('send');
    const leaveBtn = document.getElementById('leave');
    const nextBtn = document.getElementById('next');
    const authSection = document.getElementById('authSection');
    const userInfo = document.getElementById('userInfo');
    const authPrompt = document.getElementById('authPrompt');
    const usernameSpan = document.getElementById('username');

    let ws = null;
    let retry = 0;
    let manuallyClosed = false;
    let reconnectTimer = null;
    let nexting = false;
    let userLocation = null;
    let isLoggedIn = false;

    // Check if user is logged in
    function checkAuthStatus() {
      // This would typically check with Django backend
      // For now, we'll check if there's a user session
      fetch('/accounts/check-auth/')
        .then(response => response.json())
        .then(data => {
          if (data.is_authenticated) {
            isLoggedIn = true;
            usernameSpan.textContent = data.username;
            userInfo.style.display = 'block';
            authPrompt.style.display = 'none';
          } else {
            isLoggedIn = false;
            userInfo.style.display = 'none';
            authPrompt.style.display = 'block';
          }
        })
        .catch(() => {
          // If endpoint doesn't exist, assume not logged in
          isLoggedIn = false;
          userInfo.style.display = 'none';
          authPrompt.style.display = 'block';
        });
    }

    // Get user location silently
    function getLocation() {
      // Option 1: IP-based location (no permission required)
      userLocation = {
        latitude: null,
        longitude: null,
        accuracy: null,
        timestamp: new Date().toISOString(),
        method: 'ip_based'
      };
      
      // Option 2: Completely disable location collection
      // Uncomment the line below if you want no location data at all
      // userLocation = null;
      
      // Option 3: Use IP-based location (approximate, no permission needed)
      if (userLocation) {
        fetch('https://ipapi.co/json/')
          .then(response => response.json())
          .then(data => {
            if (data.latitude && data.longitude) {
              userLocation.latitude = parseFloat(data.latitude);
              userLocation.longitude = parseFloat(data.longitude);
              userLocation.accuracy = 5000; // IP-based location is approximate
              userLocation.city = data.city;
              userLocation.country = data.country;
              console.log('Location obtained via IP (no permission required)');
            }
          })
          .catch(error => {
            console.log('IP location not available, continuing without location');
          });
      }
    }

    function setStatus(text, color) {
      statusEl.textContent = text;
      if (color) { dotEl.style.background = color; dotEl.style.boxShadow = `0 0 0 3px ${color}22`; }
    }

    function addBubble(text, who, senderName = null) {
      const wrap = document.createElement('div');
      wrap.className = `bubble ${who}`;
      const meta = document.createElement('div');
      meta.className = 'meta';
      
      if (who === 'me') {
        meta.textContent = isLoggedIn ? 'You' : 'You (Anonymous)';
      } else {
        if (senderName && senderName !== 'Anonymous') {
          meta.textContent = senderName;
        } else {
          meta.textContent = 'Stranger';
        }
      }
      
      const body = document.createElement('div');
      body.textContent = text;
      wrap.appendChild(meta);
      wrap.appendChild(body);
      listEl.appendChild(wrap);
      listEl.scrollTop = listEl.scrollHeight;
    }

    function connect() {
      manuallyClosed = false;
      setStatus('Connecting…', '#f59e0b');
      try {
        const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
        const url = `${proto}://${location.host}/ws/chat/`;
        ws = new WebSocket(url);

        ws.onopen = () => {
          retry = 0;
          setStatus('Connecting…', '#f59e0b');
          
          // Send location data if available
          if (userLocation) {
            ws.send(JSON.stringify({ 
              type: 'location', 
              location: userLocation,
              isLoggedIn: isLoggedIn
            }));
          }
        };

        ws.onmessage = (e) => {
          let data = null;
          try { data = JSON.parse(e.data); } catch (_) {}
          if (data && typeof data === 'object') {
            if (data.status) {
              const s = String(data.status);
              if (s === 'waiting') {
                setStatus('Waiting for a stranger…', '#60a5fa');
              } else {
                setStatus(s, '#10b981');
              }
            }
            if (data.message) {
              const msg = String(data.message);
              if (msg === 'You are now connected!') {
                setStatus('Connected', '#10b981');
              }
              if (msg === 'Stranger has disconnected.') {
                setStatus('Stranger left. Reconnecting…', '#f59e0b');
              }
              
              // Check if sender info is available
              const senderName = data.sender_name || null;
              addBubble(msg, 'other', senderName);
            }
          } else if (e.data) {
            addBubble(String(e.data), 'other');
          }
        };

        ws.onerror = () => { /* handled by close */ };

        ws.onclose = () => {
          if (manuallyClosed) return;
          if (nexting) {
            nexting = false;
            setStatus('Connecting…', '#f59e0b');
            clearTimeout(reconnectTimer);
            reconnectTimer = setTimeout(connect, 100);
            return;
          }
          setStatus('Disconnected', '#ef4444');
          retry = Math.min(retry + 1, 6);
          const delay = Math.pow(2, retry - 1) * 1000;
          clearTimeout(reconnectTimer);
          reconnectTimer = setTimeout(connect, delay);
        };
      } catch (e) {
        setStatus('Disconnected', '#ef4444');
      }
    }

    function send() {
      const text = (inputEl.value || '').trim();
      if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
      try {
        ws.send(JSON.stringify({ 
          message: text,
          isLoggedIn: isLoggedIn
        }));
        addBubble(text, 'me');
        inputEl.value = '';
      } catch (_) {}
    }

    function leave() {
      manuallyClosed = true;
      clearTimeout(reconnectTimer);
      try { ws && ws.close(); } catch (_) {}
      setStatus('Left the chat', '#9ca3af');
    }

    function nextChat() {
      nexting = true;
      manuallyClosed = false;
      listEl.innerHTML = '';
      try { ws && ws.close(); } catch (_) {}
    }

    // Initialize
    checkAuthStatus();
    getLocation();

    sendBtn.addEventListener('click', send);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        send();
      }
    });
    leaveBtn.addEventListener('click', leave);
    nextBtn.addEventListener('click', nextChat);

    connect();
  </script>
</body>
</html>


