<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chat Admin Dashboard</title>
    <style>
        :root {
            --bg: #0f172a; --panel: #111827; --muted: #94a3b8; --border: rgba(255,255,255,0.08);
            --accent: #6366f1; --accent-2: #4f46e5; --danger: #ef4444; --success: #10b981;
        }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 20px; background: linear-gradient(180deg, #0b1020, #0f172a); color: #e5e7eb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
        h1 { margin: 0 0 12px; }
        .grid { display: grid; grid-template-columns: 1fr 2fr; gap: 16px; }
        .card { background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); border: 1px solid var(--border); border-radius: 12px; padding: 14px; }
        .stats { display: flex; gap: 12px; margin-bottom: 12px; }
        .badge { background: rgba(255,255,255,0.06); padding: 6px 10px; border-radius: 999px; color: #cbd5e1; }
        ul { padding-left: 0; list-style: none; margin: 0; }
        li { margin: 6px 0; display: flex; align-items: center; gap: 8px; }
        button { background: transparent; border: 1px solid var(--border); color: #e5e7eb; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
        button.danger { background: var(--danger); border: none; }
        #messages { height: 360px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: rgba(2,6,23,0.35); }
        #input { display: flex; gap: 8px; margin-top: 8px; }
        #msgInput { background: rgba(2,6,23,0.45); border: 1px solid var(--border); color: #e5e7eb; border-radius: 8px; padding: 10px; }
        .room-info { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .location-info { font-size: 12px; color: var(--muted); margin-top: 5px; }
        .user-badge { background: var(--success); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
        .anonymous-badge { background: var(--muted); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-left: 5px; }
    </style>
    {% csrf_token %}
    <script>
        let adminSocket = null;
        let selectedRoomId = null;
        let currentRoomData = null;

        async function fetchSummary() {
            const res = await fetch("/staff/chat/summary/");
            const data = await res.json();
            document.getElementById("totalRooms").textContent = data.total_rooms;
            document.getElementById("activeRooms").textContent = data.active_rooms;
            document.getElementById("waitingCount").textContent = data.waiting_count;
            renderRoomLists(data);
        }

        function renderRoomLists(data) {
            const activeList = document.getElementById("activeList");
            const waitingList = document.getElementById("waitingList");
            activeList.innerHTML = "";
            waitingList.innerHTML = "";
            
            (data.recent_active || []).forEach(r => {
                const li = document.createElement("li");
                const title = `${r.room_id} ‚Äî active`;
                li.innerHTML = `<button onclick=\"selectRoom('${r.room_id}')\">Open</button> ${title}`;
                activeList.appendChild(li);
            });
            
            (data.recent_waiting || []).forEach(r => {
                const li = document.createElement("li");
                const title = `${r.room_id} ‚Äî waiting`;
                li.innerHTML = `<button onclick=\"connectToWaiting('${r.room_id}')\" style=\"background:#4f46e5;color:#fff;border:none;padding:6px 10px;border-radius:6px;\">Connect</button> <button onclick=\"selectRoom('${r.room_id}')\">Open</button> ${title}`;
                waitingList.appendChild(li);
            });
        }

        function connectAdminSocket() {
            const scheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
            adminSocket = new WebSocket(`${scheme}://${window.location.host}/ws/admin/`);
            adminSocket.onopen = () => console.log('Admin socket connected');
            adminSocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'history') {
                    renderMessages(data.messages);
                } else if (data.message) {
                    appendMessage(data.message);
                } else if (data.status) {
                    console.log('Status:', data.status);
                }
            };
            adminSocket.onclose = () => console.log('Admin socket disconnected');
        }

        function selectRoom(roomId) {
            selectedRoomId = roomId;
            document.getElementById('currentRoom').textContent = roomId;
            adminSocket.send(JSON.stringify({ action: 'subscribe_room', room_id: roomId }));
            fetch(`/staff/chat/rooms/${roomId}/messages/`).then(r => r.json()).then(data => {
                currentRoomData = data;
                renderRoomInfo(data);
                renderMessages(data.messages || []);
            });
        }

        function connectToWaiting(roomId) {
            selectedRoomId = roomId;
            document.getElementById('currentRoom').textContent = roomId;
            adminSocket.send(JSON.stringify({ action: 'connect_to_waiting', room_id: roomId }));
            fetch(`/staff/chat/rooms/${roomId}/messages/`).then(r => r.json()).then(data => {
                currentRoomData = data;
                renderRoomInfo(data);
                renderMessages(data.messages || []);
            });
            // refresh lists shortly after attempting to connect
            setTimeout(fetchSummary, 600);
        }

        function renderRoomInfo(roomData) {
            const roomInfoDiv = document.getElementById('roomInfo');
            if (!roomInfoDiv) return;

            let infoHTML = '<div class="room-info">';
            infoHTML += '<h4>Room Information</h4>';
            
            if (roomData.user1) {
                const user1Type = roomData.user1.startsWith('admin:') ? 'Admin' : 'User';
                infoHTML += `<div>User 1: ${roomData.user1} <span class="${user1Type === 'Admin' ? 'user-badge' : 'anonymous-badge'}">${user1Type}</span></div>`;
                if (roomData.user1_location && roomData.user1_location.latitude) {
                    if (roomData.user1_location.method === 'ip_based') {
                        infoHTML += `<div class="location-info">üìç IP Location: ${roomData.user1_location.city || 'Unknown'}, ${roomData.user1_location.country || 'Unknown'} (Approximate)</div>`;
                    } else {
                        infoHTML += `<div class="location-info">üìç GPS Location: ${roomData.user1_location.latitude.toFixed(4)}, ${roomData.user1_location.longitude.toFixed(4)} (Accuracy: ${Math.round(roomData.user1_location.accuracy)}m)</div>`;
                    }
                }
            }
            
            if (roomData.user2) {
                const user2Type = roomData.user2.startsWith('admin:') ? 'Admin' : 'User';
                infoHTML += `<div>User 2: ${roomData.user2} <span class="${user2Type === 'Admin' ? 'user-badge' : 'anonymous-badge'}">${user2Type}</span></div>`;
                if (roomData.user2_location && roomData.user2_location.latitude) {
                    if (roomData.user2_location.method === 'ip_based') {
                        infoHTML += `<div class="location-info">üìç IP Location: ${roomData.user2_location.city || 'Unknown'}, ${roomData.user2_location.country || 'Unknown'} (Approximate)</div>`;
                    } else {
                        infoHTML += `<div class="location-info">üìç GPS Location: ${roomData.user2_location.latitude.toFixed(4)}, ${roomData.user2_location.longitude.toFixed(4)} (Accuracy: ${Math.round(roomData.user2_location.accuracy)}m)</div>`;
                    }
                }
            }
            
            infoHTML += '</div>';
            roomInfoDiv.innerHTML = infoHTML;
        }

        function renderMessages(messages) {
            const box = document.getElementById('messages');
            box.innerHTML = '';
            messages.forEach(m => {
                const senderType = m.sender.startsWith('admin:') ? 'Admin' : (m.sender_profile ? 'User' : 'Anonymous');
                const badgeClass = m.sender.startsWith('admin:') ? 'user-badge' : (m.sender_profile ? 'user-badge' : 'anonymous-badge');
                const badgeText = m.sender.startsWith('admin:') ? 'Admin' : (m.sender_profile ? 'User' : 'Anonymous');
                appendMessage(`${m.timestamp} ‚Äî ${m.sender} <span class="${badgeClass}">${badgeText}</span>: ${m.content}`);
            });
        }

        function appendMessage(text) {
            const box = document.getElementById('messages');
            const div = document.createElement('div');
            div.innerHTML = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            if (!text || !selectedRoomId) return;
            adminSocket.send(JSON.stringify({ action: 'message', message: text }));
            input.value = '';
        }

        function killSession() {
            if (!selectedRoomId) return;
            if (!confirm('Kill this session?')) return;
            adminSocket.send(JSON.stringify({ action: 'kill_room', room_id: selectedRoomId }));
        }

        function deleteRoom() {
            if (!selectedRoomId) return;
            if (!confirm('Delete this room permanently? This removes history.')) return;
            adminSocket.send(JSON.stringify({ action: 'delete_room', room_id: selectedRoomId }));
            // Clear view and refresh lists after a small delay
            setTimeout(() => { fetchSummary(); }, 500);
        }

        function deleteAllRooms() {
            if (!confirm('Delete ALL rooms and messages? This cannot be undone.')) return;
            adminSocket.send(JSON.stringify({ action: 'delete_all' }));
            selectedRoomId = null;
            document.getElementById('currentRoom').textContent = '(none)';
            document.getElementById('messages').innerHTML = '';
            document.getElementById('roomInfo').innerHTML = '';
            setTimeout(() => { fetchSummary(); }, 800);
        }

        window.addEventListener('load', () => {
            connectAdminSocket();
            fetchSummary();
            setInterval(fetchSummary, 5000);
        });
    </script>
  </head>
  <body>
    <h1>Chat Admin Dashboard</h1>
    <div class="stats">
        <div class="badge">Total: <strong id="totalRooms">0</strong></div>
        <div class="badge">Active: <strong id="activeRooms">0</strong></div>
        <div class="badge">Waiting: <strong id="waitingCount">0</strong></div>
    </div>

    <div class="grid" style="margin-top: 16px;">
        <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <h3>Rooms</h3>
                <button onclick="deleteAllRooms()" style="background:#343a40;color:#fff;border:none;padding:6px 10px;border-radius:6px;">Delete All</button>
            </div>
            <h4>Recent Active</h4>
            <ul id="activeList"></ul>
            <h4>Recent Waiting</h4>
            <ul id="waitingList"></ul>
        </div>
        <div class="card">
            <h3>Room: <span id="currentRoom">(none)</span></h3>
            <div id="roomInfo"></div>
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                <button onclick="killSession()" style="background:#d9534f;color:#fff;border:none;padding:6px 10px;border-radius:6px;">Kill Session</button>
                <button onclick="deleteRoom()" style="background:#6c757d;color:#fff;border:none;padding:6px 10px;border-radius:6px;">Delete Room</button>
            </div>
            <div id="messages"></div>
            <div id="input">
                <input id="msgInput" placeholder="Type a message as admin..." style="flex:1" />
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
  </body>
</html>

 